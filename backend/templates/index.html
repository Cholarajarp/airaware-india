<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#22C55E">
    <title>AirAware India - Live Air Quality</title>
    <style>
        :root {
            --bg-dark: #0F172A; --bg-card: #1E293B; --bg-hover: #334155;
            --text-primary: #F1F5F9; --text-secondary: #94A3B8;
            --accent: #06B6D4; --accent-hover: #0891B2; --border: #334155;
            --aqi-good: #22C55E; --aqi-moderate: #FBBF24; --aqi-unhealthy: #F97316;
            --aqi-vunhealthy: #EF4444; --aqi-hazardous: #991B1B;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg-dark); color: var(--text-primary); font-family: sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 20px; }
        .card { background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        
        /* Search & Dropdown */
        .search-container { position: relative; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; border-radius: 8px; background: var(--bg-dark); border: 1px solid var(--border); color: white; }
        #cityDropdown { 
            position: absolute; width: 100%; max-height: 200px; overflow-y: auto; 
            background: var(--bg-dark); border: 1px solid var(--border); 
            display: none; z-index: 10; 
        }
        .dropdown-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .dropdown-item:hover { background: var(--bg-hover); }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Heatmap Grid */
        .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .heatmap-city { padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; color: #000; font-weight: bold; }
        
        /* AQI Display */
        #aqiDisplay { display: none; margin-top: 20px; text-align: center; }
        .aqi-val { font-size: 60px; font-weight: 800; }
        .forecast-grid { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-top: 15px; }
        .forecast-item { min-width: 60px; background: var(--bg-dark); padding: 10px; border-radius: 6px; text-align: center; border: 1px solid var(--border); }

        @media (min-width: 768px) { .container { grid-template-columns: 2fr 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-panel">
            <div class="card">
                <h2>üîç Search City</h2>
                <div class="search-container">
                    <input type="text" id="citySearchInput" placeholder="Type city (e.g., Delhi, Mumbai...)">
                    <div id="cityDropdown"></div>
                    <input type="hidden" id="citySelect">
                </div>
                <button class="btn btn-primary" id="checkAqiBtn" disabled>Check AQI</button>

                <div id="aqiDisplay">
                    <h2 id="displayCityName">---</h2>
                    <div class="aqi-val" id="displayAqiVal">--</div>
                    <p id="displayStatus">Loading...</p>
                    
                    <h3>24H Forecast</h3>
                    <div class="forecast-grid" id="forecastGrid"></div>
                </div>
            </div>
        </div>

        <div class="side-panel">
            <div class="card">
                <h2>üáÆüá≥ Top 15 City Status</h2>
                <div class="heatmap-grid" id="heatmapGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const AQI_COLORS = {
            'good': '#22C55E', 'moderate': '#FBBF24', 'unhealthy': '#F97316', 
            'very-unhealthy': '#EF4444', 'hazardous': '#991B1B'
        };
        let citiesData = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadCities();
            setupEvents();
        });

        async function loadCities() {
            const res = await fetch('/api/cities');
            citiesData = await res.json();
            renderHeatmap(); 
        }

        function setupEvents() {
            const input = document.getElementById('citySearchInput');
            input.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                const filtered = citiesData.filter(c => c.name.toLowerCase().includes(val));
                renderDropdown(filtered);
            });
            
            document.getElementById('checkAqiBtn').addEventListener('click', fetchAQI);
            
            // Close dropdown on click outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target)) document.getElementById('cityDropdown').style.display = 'none';
            });
        }

        function renderDropdown(cities) {
            const drop = document.getElementById('cityDropdown');
            drop.innerHTML = '';
            if(cities.length === 0) return drop.style.display = 'none';
            
            cities.forEach(c => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.textContent = c.name;
                div.onclick = () => selectCityFromDropdown(c.id, c.name);
                drop.appendChild(div);
            });
            drop.style.display = 'block';
        }

        // --- FIX 2: Button Enable Logic ---
        function selectCityFromDropdown(id, name) {
            document.getElementById('citySelect').value = id;
            document.getElementById('citySearchInput').value = name;
            document.getElementById('cityDropdown').style.display = 'none';
            
            // HERE IS THE FIX: Enable the button immediately
            document.getElementById('checkAqiBtn').disabled = false;
        }

        async function fetchAQI() {
            const cityId = document.getElementById('citySelect').value;
            const btn = document.getElementById('checkAqiBtn');
            btn.textContent = "Loading...";
            
            try {
                const [aqiRes, predRes] = await Promise.all([
                    fetch(`/api/aqi?city=${cityId}`),
                    fetch(`/api/predict?city=${cityId}`)
                ]);
                
                const aqiData = await aqiRes.json();
                const predData = await predRes.json();

                renderDashboard(aqiData, predData);
            } catch(e) {
                alert("Error loading data");
            } finally {
                btn.textContent = "Check AQI";
            }
        }

        function renderDashboard(aqiData, predData) {
            const display = document.getElementById('aqiDisplay');
            const color = getAQIColor(aqiData.aqi);
            
            document.getElementById('displayCityName').textContent = aqiData.city;
            document.getElementById('displayAqiVal').textContent = aqiData.aqi;
            document.getElementById('displayAqiVal').style.color = color;
            document.getElementById('displayStatus').textContent = `Last Updated: ${aqiData.last_updated}`;
            
            const grid = document.getElementById('forecastGrid');
            grid.innerHTML = '';
            predData.forEach(p => {
                const div = document.createElement('div');
                div.className = 'forecast-item';
                div.innerHTML = `<div>${p.hour}h</div><div style="color:${getAQIColor(p.predicted_aqi)}; font-weight:bold">${p.predicted_aqi}</div>`;
                grid.appendChild(div);
            });
            
            display.style.display = 'block';
        }

        async function renderHeatmap() {
            const grid = document.getElementById('heatmapGrid');
            // Slice the first 15 cities (which we prioritized in backend)
            const topCities = citiesData.slice(0, 15);
            
            for(const city of topCities) {
                try {
                    const res = await fetch(`/api/aqi?city=${city.id}`);
                    const data = await res.json();
                    const div = document.createElement('div');
                    div.className = 'heatmap-city';
                    div.style.backgroundColor = getAQIColor(data.aqi);
                    div.innerHTML = `<div>${city.name}</div><div style="font-size:1.2em">${data.aqi}</div>`;
                    div.onclick = () => {
                        selectCityFromDropdown(city.id, city.name);
                        fetchAQI();
                    };
                    grid.appendChild(div);
                } catch(e) { console.log(e); }
            }
        }

        function getAQIColor(aqi) {
            if (aqi <= 50) return AQI_COLORS['good'];
            if (aqi <= 100) return AQI_COLORS['moderate'];
            if (aqi <= 200) return AQI_COLORS['unhealthy'];
            if (aqi <= 300) return AQI_COLORS['very-unhealthy'];
            return AQI_COLORS['hazardous'];
        }
    </script>
</body>
</html>