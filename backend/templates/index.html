<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#22C55E">
    <title id="app-title">AirAware India - Live Air Quality Monitor</title>
    <meta name="description" content="Monitor real-time Air Quality Index (AQI) across major Indian cities. Get safe time recommendations, share alerts, and stay informed about air pollution levels." />
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    
    <style>
        /* Base Dark Theme Variables */
        :root {
            --bg-dark: #0F172A;
            --bg-card: #1E293B;
            --bg-hover: #334155;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --accent: #06B6D4;
            --accent-hover: #0891B2;
            --border: #334155;
            /* AQI Colors (High Contrast) */
            --aqi-good: #22C55E;
            --aqi-moderate: #FBBF24;
            --aqi-unhealthy: #F97316;
            --aqi-vunhealthy: #EF4444;
            --aqi-hazardous: #991B1B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* Container & Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        /* Utility classes */
        .flex-row { display: flex; align-items: center; }
        .flex-col { display: flex; flex-direction: column; }

        /* Header */
        header { justify-content: space-between; padding: 15px 0; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .brand { gap: 12px; }
        .brand-icon { font-size: 28px; color: var(--accent); }
        .brand-text h1 { font-size: 20px; font-weight: 700; }
        .brand-text p { font-size: 13px; color: var(--text-secondary); }

        /* Inputs and Buttons */
        select, input, textarea {
            width: 100%; padding: 12px 16px; background: var(--bg-dark); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary); font-size: 15px; font-family: inherit; transition: all 0.2s;
        }
        select:focus, input:focus, textarea:focus { outline: none; border-color: var(--accent); }

        .btn {
            padding: 10px 18px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-outline { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-outline:hover { background: var(--bg-hover); color: var(--text-primary); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* City Selector */
        .city-select-group {
            display: grid; grid-template-columns: 3fr 1fr; gap: 15px; margin-bottom: 20px;
        }
        
        /* AQI Hero Display */
        #aqiDisplay { display: none; }
        #aqiDisplay.show { display: block; animation: fadeIn 0.5s ease-out; }

        .aqi-hero {
            padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 20px;
            border-left: 5px solid; transition: background 0.5s, border-color 0.5s;
        }

        .aqi-value-large { font-size: 72px; font-weight: 800; line-height: 1; margin: 10px 0; transition: color 0.5s; }
        .aqi-label-large { font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: color 0.5s; }
        .aqi-metadata { font-size: 12px; color: var(--text-secondary); margin-top: 15px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 8px; background: var(--bg-dark); border: 1px solid var(--border); text-align: center; }
        .stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--accent); }
        .stat-unit { font-size: 11px; color: var(--text-secondary); }

        /* Alert Box */
        .alert-box {
            padding: 15px; border-radius: 8px; border: 1px solid; display: flex; gap: 15px;
            margin-bottom: 20px; align-items: center;
        }
        .alert-icon { font-size: 24px; flex-shrink: 0; }
        .alert-content h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .alert-content p { font-size: 14px; color: var(--text-secondary); }

        /* Specific Alert Styles (uses AQI colors) */
        .alert-good { border-color: var(--aqi-good); background: rgba(34, 197, 94, 0.1); color: var(--aqi-good); }
        .alert-moderate { border-color: var(--aqi-moderate); background: rgba(251, 191, 36, 0.1); color: var(--aqi-moderate); }
        .alert-unhealthy, .alert-vunhealthy { border-color: var(--aqi-unhealthy); background: rgba(249, 115, 22, 0.1); color: var(--aqi-unhealthy); }
        .alert-hazardous { border-color: var(--aqi-hazardous); background: rgba(153, 27, 27, 0.1); color: var(--aqi-hazardous); }

        /* Actions */
        .action-bar { display: flex; gap: 15px; margin-bottom: 20px; }

        /* Forecast */
        .forecast-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px; margin-top: 15px;
        }
        .forecast-item {
            padding: 10px 5px; border-radius: 6px; background: var(--bg-dark);
            border: 1px solid var(--border); text-align: center;
        }
        .forecast-hour { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .forecast-aqi { font-size: 18px; font-weight: 700; }

        /* Heatmap Grid */
        .heatmap-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px; margin-top: 15px;
        }
        .heatmap-city {
            padding: 15px; border-radius: 8px; cursor: pointer; text-align: center;
            transition: all 0.2s; color: white;
        }
        .heatmap-city:hover { opacity: 0.8; transform: translateY(-2px); }
        .heatmap-name { font-size: 14px; font-weight: 600; }
        .heatmap-aqi { font-size: 24px; font-weight: 800; }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); z-index: 1000;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px;
            padding: 32px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { justify-content: space-between; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .close-btn { width: 32px; height: 32px; border: none; background: var(--bg-dark);
            border-radius: 6px; color: var(--text-secondary); cursor: pointer; display: flex;
            align-items: center; justify-content: center; font-size: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .container { grid-template-columns: 2fr 1fr; gap: 30px; }
            .aqi-main-panel { grid-column: 1 / 2; }
            .aqi-side-panel { grid-column: 2 / 3; }
        }
        @media (max-width: 767px) {
            .city-select-group { grid-template-columns: 1fr; }
            .action-bar button { flex-grow: 1; }
            .stats-grid { grid-template-columns: 1fr; }
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="flex-row">
            <div class="brand flex-row">
                <div class="brand-icon">üå¨Ô∏è</div>
                <div class="brand-text">
                    <h1 id="header-title">AirAware India</h1>
                    <p id="app-subtitle">Free Air Safety Monitor</p>
                </div>
            </div>
            <button class="btn btn-outline" id="langToggle" aria-label="Change Language">
                <span id="lang-text">üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
            </button>
        </header>

        <!-- Main Content Panel -->
        <div class="aqi-main-panel">
            <div class="card">
                <h2 class="form-label" id="select-city-label">1. Select City to Check</h2>
                <div class="city-select-group">
                    <select id="citySelect" aria-label="Select city">
                        <option value="">-- Choose a city (200+ available) --</option>
                    </select>
                    <button class="btn btn-primary" id="checkAqiBtn" disabled>
                        <span id="check-btn-text">Check AQI</span>
                    </button>
                </div>

                <!-- AQI Display -->
                <div id="aqiDisplay" class="flex-col">
                    <div class="aqi-hero flex-col" id="aqiHero">
                        <span class="aqi-metadata" id="cityName">---</span>
                        <div class="aqi-value-large" id="aqiValue">--</div>
                        <div class="aqi-label-large" id="aqiLabel">Loading...</div>
                        <span class="aqi-metadata" id="lastUpdated">---</span>
                    </div>

                    <!-- Safe Time Alert -->
                    <div class="alert-box" id="safeTimeAlert">
                        <div class="alert-icon" id="safeTimeIcon">‚è∞</div>
                        <div class="alert-content flex-col">
                            <h3 id="safeTimeTitle">Safe Time Recommendation</h3>
                            <p id="safeTimeText">Calculating best time for outdoor activities...</p>
                        </div>
                    </div>

                    <!-- Pollutant Stats -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-label">PM 2.5</div>
                            <div class="stat-value" id="pm25Value">--</div>
                            <div class="stat-unit">¬µg/m¬≥</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">PM 10</div>
                            <div class="stat-value" id="pm10Value">--</div>
                            <div class="stat-unit">¬µg/m¬≥</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">O‚ÇÉ</div>
                            <div class="stat-value" id="o3Value">--</div>
                            <div class="stat-unit">¬µg/m¬≥</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">NO‚ÇÇ</div>
                            <div class="stat-value" id="no2Value">--</div>
                            <div class="stat-unit">¬µg/m¬≥</div>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="action-bar">
                        <button class="btn btn-primary" id="shareBtn">
                            <span>üì±</span>
                            <span id="share-btn-text">Share Alert</span>
                        </button>
                        <button class="btn btn-outline" id="reportBtn">
                            <span>üìù</span>
                            <span id="report-btn-text">Report Issue</span>
                        </button>
                    </div>

                    <!-- Forecast Section -->
                    <h3 class="form-label" id="forecast-title" style="margin-top: 20px;">24-Hour Forecast</h3>
                    <div class="forecast-grid" id="forecastGrid">
                        <!-- Forecast items generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar/Heatmap Panel -->
        <div class="aqi-side-panel">
            <div class="card">
                <h2 class="form-label" id="heatmap-title">Top 15 City Status</h2>
                <div class="heatmap-grid" id="heatmapGrid">
                    <!-- Heatmap items generated here -->
                </div>
            </div>
            
            <!-- Subscription Card -->
            <div class="card" style="margin-top: 25px;">
                <h2 class="form-label" id="subscribe-title">Get Daily Alerts</h2>
                <form id="subscribeForm">
                    <div class="form-group">
                        <input type="text" id="subName" placeholder="Your Name" required>
                    </div>
                    <div class="form-group">
                        <input type="tel" id="subPhone" placeholder="WhatsApp Number (+91...)" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <span id="subscribe-btn-text">Subscribe Now</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <header class="modal-header flex-row">
                <h2 class="modal-title" id="modal-title">Report Air Quality Issue</h2>
                <button class="close-btn" id="closeModalBtn" aria-label="Close modal">√ó</button>
            </header>
            <form id="reportForm">
                <div class="form-group">
                    <label class="form-label" for="reportCity" id="form-city-label">City</label>
                    <input type="text" id="reportCity" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="reportLocation" id="form-location-label">Location</label>
                    <input type="text" id="reportLocation" placeholder="e.g., Near India Gate" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="reportMessage" id="form-message-label">Describe the issue</label>
                    <textarea id="reportMessage" placeholder="What air quality issue did you observe?" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span id="submit-report-text">Submit Report</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- CONSTANTS AND STATE ---
        const translations = {
            en: {
                'header-title': 'AirAware India', 'app-subtitle': 'Free Air Safety Monitor',
                'select-city-label': '1. Select City to Check', 'check-btn-text': 'Check AQI',
                'share-btn-text': 'Share Alert', 'report-btn-text': 'Report Issue',
                'forecast-title': '24-Hour Forecast', 'heatmap-title': 'Top 15 City Status',
                'subscribe-title': 'Get Daily Alerts', 'subscribe-btn-text': 'Subscribe Now',
                'safeTimeTitle': 'Safe Time Recommendation',
                'modal-title': 'Report Air Quality Issue', 'form-city-label': 'City',
                'form-location-label': 'Location', 'form-message-label': 'Describe the issue',
                'submit-report-text': 'Submit Report', 'loading': 'Loading...',
                'good': 'Good', 'moderate': 'Moderate', 'unhealthy': 'Unhealthy',
                'very-unhealthy': 'Very Unhealthy', 'hazardous': 'Hazardous',
                'safe-now': 'Safe to go outside now. Enjoy!', 'safe-evening': 'Air is poor. Best time: After 6 PM',
                'safe-late': 'Air is very unhealthy. Avoid outdoor activity; best after 8 PM',
                'stay-indoors': 'Air quality is Hazardous. Stay indoors all day',
                'last-updated-text': 'Last updated:'
            },
            hi: {
                'header-title': '‡§µ‡§æ‡§Ø‡•Å‡§Æ‡§ø‡§§‡•ç‡§∞ ‡§≠‡§æ‡§∞‡§§', 'app-subtitle': '‡§Æ‡•Å‡§´‡§º‡•ç‡§§ ‡§µ‡§æ‡§Ø‡•Å ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§Æ‡•â‡§®‡§ø‡§ü‡§∞',
                'select-city-label': '1. ‡§ú‡§æ‡§Å‡§ö ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∂‡§π‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç', 'check-btn-text': 'AQI ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç',
                'share-btn-text': '‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç', 'report-btn-text': '‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç',
                'forecast-title': '24 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡§æ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§®‡•Å‡§Æ‡§æ‡§®', 'heatmap-title': '‡§∂‡•Ä‡§∞‡•ç‡§∑ 15 ‡§∂‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø',
                'subscribe-title': '‡§¶‡•à‡§®‡§ø‡§ï ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§™‡§æ‡§è‡§Ç', 'subscribe-btn-text': '‡§Ö‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§≤‡•á‡§Ç',
                'safeTimeTitle': '‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∏‡§Æ‡§Ø ‡§ï‡•Ä ‡§∏‡§≤‡§æ‡§π',
                'modal-title': '‡§µ‡§æ‡§Ø‡•Å ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç', 'form-city-label': '‡§∂‡§π‡§∞',
                'form-location-label': '‡§∏‡•ç‡§•‡§æ‡§®', 'form-message-label': '‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§ï‡§æ ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç',
                'submit-report-text': '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç', 'loading': '‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
                'good': '‡§Ö‡§ö‡•ç‡§õ‡§æ', 'moderate': '‡§Æ‡§ß‡•ç‡§Ø‡§Æ', 'unhealthy': '‡§Ö‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø‡§ï‡§∞',
                'very-unhealthy': '‡§¨‡§π‡•Å‡§§ ‡§Ö‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø‡§ï‡§∞', 'hazardous': '‡§ñ‡§§‡§∞‡§®‡§æ‡§ï',
                'safe-now': '‡§Ö‡§≠‡•Ä ‡§¨‡§æ‡§π‡§∞ ‡§ú‡§æ‡§®‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§π‡•à‡•§ ‡§Ü‡§®‡§Ç‡§¶ ‡§≤‡•á‡§Ç!', 'safe-evening': '‡§π‡§µ‡§æ ‡§ñ‡§∞‡§æ‡§¨ ‡§π‡•à‡•§ ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§∏‡§Æ‡§Ø: ‡§∂‡§æ‡§Æ 6 ‡§¨‡§ú‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶',
                'safe-late': '‡§π‡§µ‡§æ ‡§¨‡§π‡•Å‡§§ ‡§Ö‡§∏‡•ç‡§µ‡§∏‡•ç‡§•‡§ï‡§∞ ‡§π‡•à‡•§ ‡§¨‡§æ‡§π‡§∞ ‡§ú‡§æ‡§®‡•á ‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç; ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§∞‡§æ‡§§ 8 ‡§¨‡§ú‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶',
                'stay-indoors': '‡§µ‡§æ‡§Ø‡•Å ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§ñ‡§§‡§∞‡§®‡§æ‡§ï ‡§π‡•à‡•§ ‡§™‡•Ç‡§∞‡•á ‡§¶‡§ø‡§® ‡§ò‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∞‡§π‡•á‡§Ç',
                'last-updated-text': '‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü:'
            }
        };
        const AQI_COLORS = {
            'good': 'var(--aqi-good)', 'moderate': 'var(--aqi-moderate)',
            'unhealthy': 'var(--aqi-unhealthy)', 'very-unhealthy': 'var(--aqi-vunhealthy)',
            'hazardous': 'var(--aqi-hazardous)'
        };

        let currentLang = 'en';
        let currentCityID = null;
        let currentCityName = null;
        let citiesData = []; // Holds all 200+ cities

        // --- CORE FUNCTIONS ---

        document.addEventListener('DOMContentLoaded', () => {
            loadCities();
            setupEventListeners();
            updateUILanguage();
            registerServiceWorker();
        });
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.error('SW Registration Failed:', err));
            }
        }

        async function loadCities() {
            try {
                const response = await fetch('/api/cities');
                citiesData = await response.json(); // Load ALL 200+ cities
                const select = document.getElementById('citySelect');

                // Load ALL 200+ cities into the search/selector dropdown
                citiesData.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = `${city.name}, ${city.state}`;
                    select.appendChild(option);
                });
                
                // Then, load the heatmap using only the priority subset
                loadHeatmap(); 
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        async function loadHeatmap() {
            const heatmapGrid = document.getElementById('heatmapGrid');
            heatmapGrid.innerHTML = '';
            
            // OPTIMIZATION: Use only the first 15 cities for the dashboard view
            const priorityCities = citiesData.slice(0, 15);
            
            for (const city of priorityCities) {
                try {
                    // Fetch AQI for the priority city (will use sample data quickly)
                    const response = await fetch(`/api/aqi?city=${city.id}`);
                    const data = await response.json();
                    
                    const { color, label } = getAQIInfo(data.aqi);
                    
                    const cityDiv = document.createElement('div');
                    cityDiv.className = 'heatmap-city';
                    cityDiv.style.backgroundColor = color;
                    cityDiv.title = `${city.name}: ${translate(label)}`;
                    cityDiv.innerHTML = `
                        <div class="heatmap-name">${city.name}</div>
                        <div class="heatmap-aqi">${data.aqi}</div>
                    `;
                    cityDiv.onclick = () => {
                        document.getElementById('citySelect').value = city.id;
                        document.getElementById('checkAqiBtn').disabled = false;
                        checkAQI();
                        cityDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    };
                    heatmapGrid.appendChild(cityDiv);

                } catch (error) {
                    console.error(`Error loading AQI for heatmap ${city.id}:`, error);
                    // Fallback to grey placeholder
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.className = 'heatmap-city';
                    fallbackDiv.style.backgroundColor = 'var(--text-secondary)';
                    fallbackDiv.innerHTML = `<div class="heatmap-name">${city.name}</div><div class="heatmap-aqi">--</div>`;
                    heatmapGrid.appendChild(fallbackDiv);
                }
            }
        }

        function setupEventListeners() {
            document.getElementById('citySelect').addEventListener('change', (e) => {
                document.getElementById('checkAqiBtn').disabled = !e.target.value;
            });
            document.getElementById('checkAqiBtn').addEventListener('click', checkAQI);
            document.getElementById('shareBtn').addEventListener('click', shareOnWhatsApp);
            document.getElementById('reportBtn').addEventListener('click', openReportModal);
            document.getElementById('closeModalBtn').addEventListener('click', closeReportModal);
            document.getElementById('reportModal').addEventListener('click', (e) => {
                if (e.target.id === 'reportModal') closeReportModal();
            });
            document.getElementById('reportForm').addEventListener('submit', submitReport);
            document.getElementById('langToggle').addEventListener('click', toggleLanguage);
            document.getElementById('subscribeForm').addEventListener('submit', submitSubscription);
        }

        async function checkAQI() {
            const cityId = document.getElementById('citySelect').value;
            if (!cityId) return;
            currentCityID = cityId;

            const btn = document.getElementById('checkAqiBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner"></span> <span>${translate('loading')}</span>`;
            btn.disabled = true;

            try {
                const aqiResponse = await fetch(`/api/aqi?city=${cityId}`);
                const aqiData = await aqiResponse.json();
                
                const predResponse = await fetch(`/api/predict?city=${cityId}&hours=24`);
                const predData = await predResponse.json();
                
                if (aqiData.error) throw new Error(aqiData.error);

                currentCityName = aqiData.city;
                displayAQI(aqiData);
                displayForecast(predData);

                document.getElementById('aqiDisplay').classList.add('show');
                document.getElementById('aqiDisplay').scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error('Error fetching data:', error);
                // Use custom modal or message box instead of alert
                showStatusMessage('Error', `${translate('loading')} failed. Using sample data.`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function displayAQI(data) {
            const { color, label, className } = getAQIInfo(data.aqi);
            const aqiLabelTranslated = translate(label);

            document.getElementById('cityName').textContent = data.city;
            document.getElementById('aqiValue').textContent = data.aqi;
            document.getElementById('aqiLabel').textContent = aqiLabelTranslated;
            document.getElementById('lastUpdated').textContent = `${translate('last-updated-text')}: ${data.last_updated}`;
            
            const hero = document.getElementById('aqiHero');
            hero.style.backgroundColor = color + '22';
            hero.style.borderColor = color;

            document.getElementById('aqiValue').style.color = color;
            document.getElementById('aqiLabel').style.color = color;

            document.getElementById('pm25Value').textContent = data.pm25 || '--';
            document.getElementById('pm10Value').textContent = data.pm10 || '--';
            document.getElementById('o3Value').textContent = data.o3 || '--';
            document.getElementById('no2Value').textContent = data.no2 || '--';

            updateSafeTime(data.aqi);
        }

        function updateSafeTime(aqi) {
            const alert = document.getElementById('safeTimeAlert');
            let message, alertClass, icon;

            if (aqi <= 100) {
                message = 'safe-now'; alertClass = 'alert-good'; icon = '‚úÖ';
            } else if (aqi <= 200) {
                message = 'safe-evening'; alertClass = 'alert-moderate'; icon = '‚ö†Ô∏è';
            } else if (aqi <= 300) {
                message = 'safe-late'; alertClass = 'alert-vunhealthy'; icon = '‚õî';
            } else {
                message = 'stay-indoors'; alertClass = 'alert-hazardous'; icon = 'üõë';
            }

            alert.className = `alert-box ${alertClass}`;
            document.getElementById('safeTimeText').textContent = translate(message);
            document.getElementById('safeTimeIcon').textContent = icon;
            document.getElementById('safeTimeIcon').style.color = 'inherit'; // Ensure icon color is inherited from alert box
        }

        function displayForecast(data) {
            const grid = document.getElementById('forecastGrid');
            grid.innerHTML = '';

            if (!data || !data.length) return;

            data.slice(0, 12).forEach(item => {
                const { color } = getAQIInfo(item.predicted_aqi);

                const forecastItem = document.createElement('div');
                forecastItem.className = 'forecast-item';
                forecastItem.style.borderLeft = `3px solid ${color}`;
                forecastItem.title = `AQI: ${item.predicted_aqi}`;
                forecastItem.innerHTML = `
                    <div class="forecast-hour">${item.hour}h</div>
                    <div class="forecast-aqi" style="color: ${color}">${item.predicted_aqi}</div>
                `;
                grid.appendChild(forecastItem);
            });
        }
        
        // --- TRANSLATION & LOGIC HELPERS ---
        
        function translate(key) {
            return translations[currentLang][key] || key;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'hi' : 'en';
            document.getElementById('lang-text').textContent = currentLang === 'en' ? 'üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä' : 'üåê English';
            updateUILanguage();
            // Re-render heatmap to update localized titles/tooltips
            loadHeatmap(); 
        }

        function updateUILanguage() {
            Object.keys(translations[currentLang]).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                         const placeholderText = translations[currentLang][key];
                         element.placeholder = placeholderText.includes('...') ? placeholderText : placeholderText + '...';
                    } else {
                        element.textContent = translations[currentLang][key];
                    }
                }
            });

            const aqiValue = document.getElementById('aqiValue').textContent;
            if (aqiValue !== '--') {
                const aqi = parseInt(aqiValue);
                const { label } = getAQIInfo(aqi);
                document.getElementById('aqiLabel').textContent = translate(label);
                updateSafeTime(aqi);
            }
        }

        function getAQIInfo(aqi) {
            let label;
            if (aqi <= 50) { label = 'good'; }
            else if (aqi <= 100) { label = 'moderate'; }
            else if (aqi <= 200) { label = 'unhealthy'; }
            else if (aqi <= 300) { label = 'very-unhealthy'; }
            else { label = 'hazardous'; }
            
            return { 
                color: AQI_COLORS[label.replace('-', '').substring(0, 8)], 
                label: label, 
                className: `alert-${label}` 
            };
        }

        // --- SUBMISSION HANDLERS ---
        
        // Simplified message box replacement for alert()
        function showStatusMessage(title, message) {
            const modal = document.getElementById('reportModal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('reportForm').style.display = 'none';
            document.getElementById('reportCity').value = ''; 
            
            document.getElementById('form-city-label').textContent = message; 

            modal.classList.add('show');
        }

        function shareOnWhatsApp() {
            if (!currentCityName) {
                 showStatusMessage("Error", currentLang === 'en' ? 'Please check AQI for a city first.' : '‡§™‡§π‡§≤‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§∂‡§π‡§∞ ‡§ï‡§æ AQI ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§');
                 return;
            }

            const aqi = document.getElementById('aqiValue').textContent;
            const label = document.getElementById('aqiLabel').textContent;
            const safeTime = document.getElementById('safeTimeText').textContent;

            const text = `üå¨Ô∏è *AirAware India Alert*\n\nüìç ${currentCityName}\nüî¢ AQI: ${aqi}\nüìä Status: ${label}\n\n‚ö†Ô∏è ${safeTime}\n\nCheck your city's air quality now!`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappUrl, '_blank');
        }

        function openReportModal() {
            if (!currentCityName) {
                showStatusMessage("Report Error", currentLang === 'en' ? 'Please select a city first' : '‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§è‡§ï ‡§∂‡§π‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç');
                return;
            }
            document.getElementById('reportCity').value = currentCityName;
            document.getElementById('reportModal').classList.add('show');
            document.getElementById('reportForm').style.display = 'block'; // Show form
            document.getElementById('modal-title').textContent = translate('modal-title');
            document.getElementById('form-city-label').textContent = translate('form-city-label');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('show');
            document.getElementById('reportForm').reset();
        }

        async function submitReport(e) {
            e.preventDefault();

            const city = document.getElementById('reportCity').value;
            const location = document.getElementById('reportLocation').value;
            const message = document.getElementById('reportMessage').value;
            
            const submitBtn = e.submitter;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `<span class="spinner"></span>`;
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/reports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ city, location, message })
                });

                if (response.ok) {
                    showStatusMessage(
                        currentLang === 'en' ? 'Success' : '‡§∏‡§´‡§≤‡§§‡§æ', 
                        currentLang === 'en' ? 'Report submitted successfully!' : '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡§Æ‡§æ ‡§ï‡•Ä ‡§ó‡§à!'
                    );
                    setTimeout(closeReportModal, 2000);
                } else {
                    throw new Error('Server failure');
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                showStatusMessage(
                    currentLang === 'en' ? 'Error' : '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', 
                    currentLang === 'en' ? 'Failed to submit report. Please try again.' : '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§'
                );
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        async function submitSubscription(e) {
            e.preventDefault();
            
            const name = document.getElementById('subName').value;
            const phone = document.getElementById('subPhone').value;
            const city = document.getElementById('citySelect').value;
            const language = currentLang;

            if (!city) {
                showStatusMessage("Subscription Error", currentLang === 'en' ? 'Please select a city first before subscribing.' : '‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§≤‡•á‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§∂‡§π‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§');
                return;
            }
            
            const submitBtn = e.submitter;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = `<span class="spinner"></span>`;
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, phone_or_whatsapp: phone, city, language })
                });

                if (response.ok) {
                    showStatusMessage(
                        currentLang === 'en' ? 'Success' : '‡§∏‡§´‡§≤‡§§‡§æ',
                        currentLang === 'en' ? 'Subscribed successfully! We will contact you.' : '‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§∏‡§´‡§≤ ‡§∞‡§π‡•Ä! ‡§π‡§Æ ‡§Ü‡§™‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á‡•§'
                    );
                    document.getElementById('subscribeForm').reset();
                } else {
                    const errorData = await response.json();
                    showStatusMessage(
                        currentLang === 'en' ? 'Error' : '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø',
                        errorData.message || (currentLang === 'en' ? 'Subscription failed.' : '‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡•Ä‡•§')
                    );
                }
            } catch (error) {
                console.error('Error submitting subscription:', error);
                showStatusMessage(
                    currentLang === 'en' ? 'Error' : '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø',
                    currentLang === 'en' ? 'Failed to subscribe. Network error.' : '‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡•Ä‡•§ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§'
                );
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                setTimeout(closeReportModal, 2000);
            }
        }
    </script>
</body>
</html>